//
//  FiltersInteractor.swift
//  IteoLogger
//
//  Created by Patryk Średziński on 05/02/2021.
//  Copyright (c) 2021 iteo. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates by Patryk Średziński
//

import Foundation

protocol FiltersInteractor {
    func reloadFilters()
    func toggleFramework(_ framework: String)
    func toggleLevel(_ level: IteoLoggerLevel)
    func toggleModule(_ module: IteoLoggerModule)
    func toggleAllFrameworks()
    func toggleAllLevels()
    func toggleAllModules()
    func clearAllFilters()
    func saveFilters()
}

final class FiltersInteractorImpl {
    
    private let presenter: FiltersPresenter
    private let worker: FiltersWorker
    private let router: FiltersRouter
    private var filter: LogFilter
    private let availableFrameworks: Set<String>
    private let availableModules: Set<IteoLoggerModule>
    private let availableLevels: Set<IteoLoggerLevel>
    
    init(presenter: FiltersPresenter,
         worker: FiltersWorker,
         router: FiltersRouter,
         filter: LogFilter,
         availableFrameworks: Set<String>,
         availableModules: Set<IteoLoggerModule>,
         availableLevels: Set<IteoLoggerLevel>) {
        self.presenter = presenter
        self.worker = worker
        self.router = router
        self.filter = filter
        self.availableFrameworks = availableFrameworks
        self.availableModules = availableModules
        self.availableLevels = availableLevels
    }
    
    func toggleFramework(_ framework: String) {
        var currentSet = filter.frameworks.selectedItems(from: availableFrameworks)
        if currentSet.contains(framework) {
            currentSet.remove(framework)
        } else {
            currentSet.insert(framework)
        }
        filter.frameworks = .selected(currentSet)
        reloadFilters()
    }
    
    func toggleLevel(_ level: IteoLoggerLevel) {
        var currentSet = filter.levels.selectedItems(from: availableLevels)
        if currentSet.contains(level) {
            currentSet.remove(level)
        } else {
            currentSet.insert(level)
        }
        filter.levels = .selected(currentSet)
        reloadFilters()
    }
    
    func toggleModule(_ module: IteoLoggerModule) {
        var currentSet = filter.modules.selectedItems(from: availableModules)
        if currentSet.contains(module) {
            currentSet.remove(module)
        } else {
            currentSet.insert(module)
        }
        filter.modules = .selected(currentSet)
        reloadFilters()
    }
    
    func toggleAllFrameworks() {
        if filter.frameworks.isAll {
            filter.frameworks = .selected([])
        } else {
            filter.frameworks = .all
        }
        reloadFilters()
    }
    
    func toggleAllLevels() {
        if filter.levels.isAll {
            filter.levels = .selected([])
        } else {
            filter.levels = .all
        }
        reloadFilters()
    }
    
    func toggleAllModules() {
        if filter.modules.isAll {
            filter.modules = .selected([])
        } else {
            filter.modules = .all
        }
        reloadFilters()
    }
    
    func clearAllFilters() {
        filter.frameworks = .all
        filter.modules = .all
        filter.levels = .all
        reloadFilters()
    }
    
    func saveFilters() {
        router.saveFilters(filter)
        do {
            try worker.saveFilters(filter)
        } catch {
            presenter.showError(error)
        }
    }
    
}

extension FiltersInteractorImpl: FiltersInteractor {
    
    func reloadFilters() {
        presenter.reloadFilters(filter, availableFrameworks: availableFrameworks, availableModules: availableModules, availableLevels: availableLevels)
    }
    
}
